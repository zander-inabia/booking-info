version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: purchases Build and push Docker image
          command: |
            cd src/purchases
            sudo docker build -t zanderinabia/purchases:${CIRCLE_BUILD_NUM} .
            sudo docker login -u "$username" -p "$password"
            sudo docker push zanderinabia/purchases:${CIRCLE_BUILD_NUM}
            curl --request POST -H "Content-Type: application/json" -H "X-AUTH-TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb21wYW55SWQiOiI1ZGFhYzRkZjZhOWUyZjAwMWM3ZDgzYjAiLCJleHAiOiIxOTE0NDk0NDA2NTkzIiwiaXNBZG1pbiI6ImZhbHNlIiwiaXNzIjoiQ2xvdWRwbGV4IiwibXlyb2xlcyI6WyJTdXBlci1Vc2VyIiwiVGVhbSBMZWFkIl0sInRlYW1zX3JvbGVzIjp7IkJhY2tlbmQgVGVhbSI6IlRlYW0gTGVhZCJ9LCJ0b2tlbl90eXBlIjoiMSIsInVzZXJuYW1lIjoiaGFzZWViQGNsb3VkcGxleC5pbyJ9.rVN2_DQMB6hIgkyVeaNFuDWDU84XtI0fhdTMoKfhDSk" --data '{"image_name":"zanderinabia/purchases","tag": "'"${CIRCLE_BUILD_NUM}"'" , "type":"container", "application_ids":["bookinfo-application-v1"]}' https://app.cloudplex.io/rabbit/api/v1/cd/trigger/deployment
      - run:
          name: productpage Build and push Docker image
          command: |
            cd src/productpage
            sudo docker build -t zanderinabia/productpage:${CIRCLE_BUILD_NUM} .
            sudo docker login -u "$username" -p "$password"
            sudo docker push zanderinabia/productpage:${CIRCLE_BUILD_NUM}
            curl --request POST -H "Content-Type: application/json" -H "X-AUTH-TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb21wYW55SWQiOiI1ZGFhYzRkZjZhOWUyZjAwMWM3ZDgzYjAiLCJleHAiOiIxOTE0NDk0NDA2NTkzIiwiaXNBZG1pbiI6ImZhbHNlIiwiaXNzIjoiQ2xvdWRwbGV4IiwibXlyb2xlcyI6WyJTdXBlci1Vc2VyIiwiVGVhbSBMZWFkIl0sInRlYW1zX3JvbGVzIjp7IkJhY2tlbmQgVGVhbSI6IlRlYW0gTGVhZCJ9LCJ0b2tlbl90eXBlIjoiMSIsInVzZXJuYW1lIjoiaGFzZWViQGNsb3VkcGxleC5pbyJ9.rVN2_DQMB6hIgkyVeaNFuDWDU84XtI0fhdTMoKfhDSk" --data '{"image":"zanderinabia/productpage","tag": "'"${CIRCLE_BUILD_NUM}"'" , "type":"container", "application_ids":["bookinfo-application-v1"]}' https://app.cloudplex.io/rabbit/api/v1/cd/trigger/deployment
